---
title: "Data Wrangling and Analysis of Experiment Results"
author: "Masoud Jasbi"
date: "7/8/2019"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE)
```

```{r libraries, include=FALSE}
library(tidyverse)
library(ggthemes)
library(VIM)
```

## Data Wrangling

```{r import_data}
qualtrics_data <- read.csv("data/quantifiers_data_raw.csv", na.strings = "")

#let's remove the previews and the ones we ran for testing ourselves
qualtrics_data <- qualtrics_data[-1:-58,]
```

```{r exclusions}
# How many people dropped out of the experiment?
N_dropout <-
  qualtrics_data %>%
  filter(Finished=="False") %>%
  nrow()

# How many people did not speak English?
N_nonEnglish <-
  qualtrics_data %>%
  filter(Q239=="46" | Q239=="Italian" | Q239=="Spanish")

# How man were under 18? (no one)
N_under18 <-
  qualtrics_data %>%
  filter(Q238=="Under 18")

# How many failed the attention checks?
N_inattentive <-
  qualtrics_data %>%
  filter(Q240_1!=70 | Q246_1!=30)

# How many people are included?
included_data <- 
  qualtrics_data %>%
  filter(Finished=="True") %>%
  filter(Q239!="46", Q239!="Italian", Q239!="Spanish") %>%
  filter(Q238!="Under 18") %>%
  filter(Q240_1==70 | Q246_1==30)

# number of included participants
N_participants <-
  included_data %>%
  nrow()

# check to see if number of IP addresses match number of participants
N_IPAddress <- included_data$IPAddress %>% unique() %>% length()
```

Total of `r nrow(qualtrics_data)` took this survey. `r N_dropout` did not finish the survey and dropped out. `r N_nonEnglish` reported their language as other than English. `r N_under18` participants were under 18. And `r N_inattentive` participants failed at least one of the attention checks. The results for `r N_participants` are reported.

```{r}
# let's retrieve the question quantifier and context from the handcoded dataframe
handTrimmed <- read.csv("data/handtrimmed-final-quantifiers.csv")

columnVariables <- 
  handTrimmed %>%
  select(-mTurkCode, -Age, -Language, -UserLanguage) %>%
  mutate(sid=c(1:nrow(handTrimmed))) %>%
  colnames()

tidy_data <-
  included_data %>%
  mutate(sid=c(1:nrow(included_data))) %>% # add subject ID column
  select(-StartDate, -EndDate, -Status, -IPAddress, -Progress, -Duration..in.seconds.,-Finished, -RecordedDate, -ResponseId, -RecipientFirstName, -RecipientLastName, -RecipientEmail, -ExternalReference, -LocationLatitude, -LocationLongitude, -DistributionChannel, -UserLanguage, -mTurkCode, -Q238, -Q239) # remove useless columns column

names(tidy_data) <- columnVariables

long_data <-
  tidy_data %>%
  gather(quantifier_context, response, Every_GroceryStore:Never_Biked) %>%
  drop_na(response) %>%
  separate(quantifier_context, c("quantifier", "context"), sep = "_")

write.csv(long_data, "data/Quantifiers_processed_data.csv", row.names=FALSE)
```

## Plots

```{r QuantifierDistribution}
long_data %>%
  ggplot(aes(as.numeric(response))) +
  geom_histogram() + 
  facet_wrap(.~quantifier) +
  theme_few()
```

```{r conditionDistribution}
long_data %>%
  ggplot(aes(as.numeric(response))) +
  geom_histogram() + 
  facet_wrap(.~context) +
  theme_few()
```


```{r boxplot}
long_data$quantifier <- reorder(long_data$quantifier, long_data$response, mean)

long_data %>%
  ggplot(aes(quantifier, as.numeric(response))) +
  geom_boxplot() +
  geom_jitter(size=0.5) +
  theme_few() + 
  theme(axis.text.x = element_text(angle=45, hjust = 1, vjust = 1))
```

## Analysis

K-means Clustering

```{r kmeansClustering}
kmeans_data1 <-
  tidy_data %>%
  filter(condition=="nominal") %>%
  spread(quantifier, response) %>%
  select(-sid, -condition)

kmeans_data2 <-
  tidy_data %>%
  filter(condition=="temporal") %>%
  spread(quantifier, response) %>%
  select(-sid, -condition)

kmeans_data <- 
  bind_cols(kmeans_data1, kmeans_data2) %>%
  select(-no_days, Never) %>%
  drop_na()

df2 <- data.frame(t(kmeans_data[-1]))
colnames(df2) <- kmeans_data[, 1]
  
quantifier_clusters <- kmeans(df2, centers=4, nstart = 25)
quantifier_clusters$cluster
```

4 clusters:

* each-day, every-day, all-days, always
* often, usually, frequently, mostly, many-days, most-days
* infrequently, sometimes, some-days,
* few-days, several-days, seldom, rarely, occasionally, (never)

5 clusters:

* every-day, each-day, always
* often, usually
* most-days, many-days, frequently, mostly
* few-days, several-days, rarely, occasionally, (never)
* some-days, some-times

(never should be interpreted with caution because there were not enough data points and its similar quantifiers were ommitted in a previoius step)
